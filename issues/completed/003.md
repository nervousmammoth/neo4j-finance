# Issue 003: CSV Parser with Validation

## Branch Name
`issue/003-csv-parser`

## Objective
Create a robust CSV parser with:
- Support for various encodings (UTF-8, ISO-8859-1)
- Header detection and validation
- Large file streaming
- Error handling for malformed CSVs
- Column type inference

## Dependencies
- Issue 002 merged
- `papaparse` package

## Phase: RED - Write Failing Tests

### Test Cases
1. Valid CSV with headers
2. CSV without headers
3. Empty CSV file
4. Malformed CSV (missing columns)
5. CSV with special characters
6. CSV with different delimiters (comma, semicolon, tab)
7. Large CSV file (streaming)
8. CSV with encoding issues
9. CSV with quoted fields
10. CSV with escaped quotes
11. CSV with empty rows
12. CSV with whitespace in headers
13. CSV with duplicate headers
14. CSV with BOM (Byte Order Mark)
15. CSV with line breaks in quoted fields

### Test File Location
`__tests__/unit/lib/csv-parser.test.ts`

### Expected Test Code
```typescript
import { describe, it, expect } from 'vitest'
import { parseCSV, ParseResult } from '@/lib/csv-parser'

describe('CSV Parser', () => {
  it('should parse valid CSV with headers', async () => {
    const csv = 'name,age\nJohn,30\nJane,25'
    const result = await parseCSV(csv)

    expect(result.success).toBe(true)
    expect(result.data).toHaveLength(2)
    expect(result.data[0]).toEqual({ name: 'John', age: '30' })
  })

  it('should handle CSV without headers', async () => {
    const csv = 'John,30\nJane,25'
    const result = await parseCSV(csv, { header: false })

    expect(result.success).toBe(true)
    expect(result.data[0]).toBeInstanceOf(Array)
  })

  it('should detect empty CSV file', async () => {
    const csv = ''
    const result = await parseCSV(csv)

    expect(result.success).toBe(false)
    expect(result.error).toContain('empty')
  })

  // ... more tests
})
```

### Git Commit
```bash
git add __tests__/unit/lib/csv-parser.test.ts
git commit -m "test: add failing tests for CSV parser"
```

## Phase: GREEN - Implement

### Install Dependencies
```bash
npm install papaparse
npm install -D @types/papaparse
```

### Implementation (`lib/csv-parser.ts`)
```typescript
import Papa from 'papaparse'

export interface ParseResult<T = any> {
  success: boolean
  data: T[]
  errors: ParseError[]
  meta: {
    delimiter: string
    linebreak: string
    headers: string[]
    rowCount: number
  }
}

export interface ParseError {
  type: string
  code: string
  message: string
  row?: number
}

export interface ParseOptions {
  header?: boolean
  delimiter?: string
  skipEmptyLines?: boolean
  transformHeader?: (header: string) => string
}

export async function parseCSV<T = any>(
  input: string | File,
  options: ParseOptions = {}
): Promise<ParseResult<T>> {
  return new Promise((resolve) => {
    const config: Papa.ParseConfig = {
      header: options.header !== false,
      delimiter: options.delimiter || '',
      skipEmptyLines: options.skipEmptyLines !== false,
      transformHeader: options.transformHeader || ((h) => h.trim()),
      complete: (results) => {
        if (results.errors.length > 0) {
          resolve({
            success: false,
            data: [],
            errors: results.errors.map(err => ({
              type: err.type,
              code: err.code,
              message: err.message,
              row: err.row,
            })),
            meta: {
              delimiter: results.meta.delimiter,
              linebreak: results.meta.linebreak,
              headers: results.meta.fields || [],
              rowCount: results.data.length,
            },
          })
        } else {
          resolve({
            success: true,
            data: results.data as T[],
            errors: [],
            meta: {
              delimiter: results.meta.delimiter,
              linebreak: results.meta.linebreak,
              headers: results.meta.fields || [],
              rowCount: results.data.length,
            },
          })
        }
      },
      error: (error) => {
        resolve({
          success: false,
          data: [],
          errors: [{
            type: 'Error',
            code: 'PARSE_ERROR',
            message: error.message,
          }],
          meta: {
            delimiter: '',
            linebreak: '',
            headers: [],
            rowCount: 0,
          },
        })
      },
    }

    if (typeof input === 'string') {
      Papa.parse(input, config)
    } else {
      Papa.parse(input, config)
    }
  })
}
```

### Git Commit
```bash
git add lib/csv-parser.ts
git commit -m "feat: implement CSV parser with papaparse"
```

## Phase: REFACTOR

### Refactoring Goals
- Add streaming support for large files
- Improve error messages
- Add column type inference
- Create validation helpers

### Git Commit
```bash
git add lib/csv-parser.ts
git commit -m "refactor: add streaming and type inference"
```

## Pull Request

### Create PR
```bash
git push origin issue/003-csv-parser
gh pr create --title "Issue 003: CSV Parser with Validation" \
             --body "$(cat issues/003.md)" \
             --label "backend"
```

### PR Checklist
- [ ] All 15+ tests pass
- [ ] Coverage >= 100%
- [ ] Handles edge cases
- [ ] CI checks pass
- [ ] PR approved

### Merge
```bash
gh pr merge --squash
```

## Acceptance Criteria
- [ ] Parses valid CSVs correctly
- [ ] Handles all edge cases
- [ ] All tests pass (15+ tests)
- [ ] Coverage >= 100%
- [ ] PR merged âœ…

## Estimated Effort
**M** (Medium)
