# Issue 005: Schema Validator for Banking Entities

## Branch Name
`issue/005-schema-validator`

## Objective
Create Zod schemas for all banking entities (Person, Account, Bank, Company, Transaction) with detailed validation rules.

## Dependencies
- Issue 001 merged
- `zod` package

## Phase: RED - Write Failing Tests

### Test Cases (20+, 4 per entity)
**Person:**
1. Valid person object
2. Missing required field (person_id)
3. Invalid date format
4. Invalid risk_level enum

**BankAccount:**
5. Valid account object
6. Missing IBAN
7. Invalid account_type
8. Negative balance

**Bank:**
9. Valid bank object
10. Missing bank_id
11. Invalid country code
12. Empty name

**Company:**
13. Valid company object
14. Missing company_id
15. Invalid boolean for is_shell_company
16. Invalid date format

**Transaction:**
17. Valid transaction object
18. Missing from_iban
19. Negative amount
20. Invalid transaction_type enum

### Test File Location
`__tests__/unit/lib/validators/schema.test.ts`

### Git Commit
```bash
git commit -m "test: add failing tests for schema validators"
```

## Phase: GREEN - Implement

### Install Dependencies
```bash
npm install zod
```

### Implementation (`lib/validators/schema.ts`)
```typescript
import { z } from 'zod'

export const PersonSchema = z.object({
  person_id: z.string().min(1),
  ssn: z.string().optional(),
  first_name: z.string().min(1),
  last_name: z.string().min(1),
  date_of_birth: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  nationality: z.string().min(1),
  risk_level: z.enum(['LOW', 'MEDIUM', 'HIGH', 'CRITICAL']),
  investigation_status: z.enum(['NONE', 'MONITORING', 'ACTIVE', 'CLOSED']),
  occupation: z.string().optional(),
  alias: z.string().optional(),
})

export const BankAccountSchema = z.object({
  account_id: z.string().min(1),
  iban: z.string().regex(/^[A-Z]{2}\d{2}[A-Z0-9]+$/),
  bank_id: z.string().min(1),
  account_type: z.enum(['CHECKING', 'SAVINGS', 'BUSINESS']),
  country: z.string().min(1),
  currency: z.string().default('EUR'),
  current_balance: z.number(),
  opened_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  closed_date: z.string().optional(),
  status: z.enum(['ACTIVE', 'CLOSED', 'FROZEN']).default('ACTIVE'),
})

export const BankSchema = z.object({
  bank_id: z.string().min(1),
  name: z.string().min(1),
  country: z.string().min(1),
  routing_number: z.string().min(1),
})

export const CompanySchema = z.object({
  company_id: z.string().min(1),
  registration_number: z.string().min(1),
  name: z.string().min(1),
  country: z.string().min(1),
  business_type: z.string().min(1),
  is_shell_company: z.boolean(),
  incorporation_date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
  status: z.enum(['ACTIVE', 'DISSOLVED', 'SUSPENDED']).default('ACTIVE'),
})

export const TransactionSchema = z.object({
  transaction_id: z.string().min(1),
  from_iban: z.string().regex(/^[A-Z]{2}\d{2}[A-Z0-9]+$/),
  to_iban: z.string().regex(/^[A-Z]{2}\d{2}[A-Z0-9]+$/),
  amount: z.number().positive(),
  currency: z.string().default('EUR'),
  date: z.string().regex(/^\d{4}-\d{2}-\d{2}( \d{2}:\d{2}:\d{2})?$/),
  transaction_type: z.enum(['WIRE', 'TRANSFER', 'PAYMENT', 'CASH']),
  reference: z.string().optional(),
  description: z.string().optional(),
  is_flagged: z.boolean().default(false),
  flag_reason: z.string().optional(),
})

export type Person = z.infer<typeof PersonSchema>
export type BankAccount = z.infer<typeof BankAccountSchema>
export type Bank = z.infer<typeof BankSchema>
export type Company = z.infer<typeof CompanySchema>
export type Transaction = z.infer<typeof TransactionSchema>
```

### Git Commit
```bash
git commit -m "feat: implement Zod schemas for all entities"
```

## Phase: REFACTOR

### Refactoring Goals
- Add custom error messages
- Create validation helpers
- Add batch validation

### Git Commit
```bash
git commit -m "refactor: improve validation error messages"
```

## Acceptance Criteria
- [ ] All 20+ tests pass
- [ ] Coverage >= 100%
- [ ] All entities validated
- [ ] PR merged âœ…

## Estimated Effort
**M** (Medium)
