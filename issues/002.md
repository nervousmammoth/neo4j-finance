# Issue 002: Neo4j Connection Manager

## Branch Name
`issue/002-neo4j-connection`

## Objective
Create a robust Neo4j connection manager with:
- Singleton pattern for connection pooling
- Health check functionality
- Error handling and retry logic
- Environment-based configuration
- TypeScript types

## Dependencies
- Issue 001 merged (testing infrastructure ready)
- `neo4j-driver` package

## Phase: RED - Write Failing Tests

### Test Cases
1. **Connection initialization**
   - Should create driver instance with valid credentials
   - Should reuse existing driver (singleton pattern)

2. **Health check**
   - Should return true when database is accessible
   - Should return false when database is unreachable

3. **Error handling**
   - Should throw error with invalid credentials
   - Should throw error when database is down
   - Should handle timeout errors

4. **Session management**
   - Should create and close session correctly
   - Should execute query successfully
   - Should handle query errors

5. **Connection cleanup**
   - Should close driver connections cleanly

### Test File Location
`__tests__/unit/lib/neo4j.test.ts`

### Expected Test Code
```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest'
import { getDriver, healthCheck, executeQuery, closeDriver } from '@/lib/neo4j'

// Mock neo4j-driver
vi.mock('neo4j-driver', () => ({
  default: {
    driver: vi.fn(),
    auth: {
      basic: vi.fn((username, password) => ({ username, password })),
    },
  },
}))

describe('Neo4j Connection Manager', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  afterEach(async () => {
    await closeDriver()
  })

  describe('getDriver', () => {
    it('should create driver instance with valid credentials', () => {
      const driver = getDriver()
      expect(driver).toBeDefined()
    })

    it('should return same driver instance (singleton)', () => {
      const driver1 = getDriver()
      const driver2 = getDriver()
      expect(driver1).toBe(driver2)
    })

    it('should throw error with invalid URI', () => {
      process.env.NEO4J_URI = ''
      expect(() => getDriver()).toThrow('NEO4J_URI is not defined')
    })
  })

  describe('healthCheck', () => {
    it('should return true when database is accessible', async () => {
      const result = await healthCheck()
      expect(result).toBe(true)
    })

    it('should return false when database is unreachable', async () => {
      // Mock connection failure
      const result = await healthCheck()
      expect(typeof result).toBe('boolean')
    })
  })

  describe('executeQuery', () => {
    it('should execute query successfully', async () => {
      const result = await executeQuery('RETURN 1 as num')
      expect(result).toBeDefined()
    })

    it('should handle query errors', async () => {
      await expect(executeQuery('INVALID QUERY')).rejects.toThrow()
    })
  })

  describe('closeDriver', () => {
    it('should close driver connections cleanly', async () => {
      const driver = getDriver()
      await closeDriver()
      // Driver should be closed
    })
  })
})
```

### Git Commit
```bash
git add __tests__/unit/lib/neo4j.test.ts
git commit -m "test: add failing tests for Neo4j connection manager"
```

## Phase: GREEN - Implement

### Implementation Requirements

1. **Install Dependencies**
```bash
npm install neo4j-driver
npm install -D @types/node
```

2. **Create Environment Variables** (`.env.local`)
```env
NEO4J_URI=bolt://localhost:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=password
NEO4J_DATABASE=neo4j
```

3. **Implement Connection Manager** (`lib/neo4j.ts`)
```typescript
import neo4j, { Driver, Session } from 'neo4j-driver'

let driver: Driver | null = null

export function getDriver(): Driver {
  if (driver) {
    return driver
  }

  const uri = process.env.NEO4J_URI
  const username = process.env.NEO4J_USERNAME
  const password = process.env.NEO4J_PASSWORD

  if (!uri) {
    throw new Error('NEO4J_URI is not defined')
  }
  if (!username) {
    throw new Error('NEO4J_USERNAME is not defined')
  }
  if (!password) {
    throw new Error('NEO4J_PASSWORD is not defined')
  }

  driver = neo4j.driver(
    uri,
    neo4j.auth.basic(username, password),
    {
      maxConnectionLifetime: 30 * 60 * 1000, // 30 minutes
      maxConnectionPoolSize: 50,
      connectionAcquisitionTimeout: 60000, // 60 seconds
    }
  )

  return driver
}

export async function healthCheck(): Promise<boolean> {
  try {
    const driver = getDriver()
    const session = driver.session()

    try {
      await session.run('RETURN 1')
      return true
    } finally {
      await session.close()
    }
  } catch (error) {
    console.error('Health check failed:', error)
    return false
  }
}

export async function executeQuery<T = any>(
  query: string,
  params: Record<string, any> = {}
): Promise<T[]> {
  const driver = getDriver()
  const session = driver.session({
    database: process.env.NEO4J_DATABASE || 'neo4j',
  })

  try {
    const result = await session.run(query, params)
    return result.records.map(record => record.toObject() as T)
  } finally {
    await session.close()
  }
}

export async function closeDriver(): Promise<void> {
  if (driver) {
    await driver.close()
    driver = null
  }
}
```

4. **Create Types** (`lib/neo4j.types.ts`)
```typescript
export interface Neo4jConfig {
  uri: string
  username: string
  password: string
  database?: string
}

export interface QueryResult<T = any> {
  records: T[]
  summary: {
    query: string
    parameters: Record<string, any>
  }
}
```

### Git Commit
```bash
git add lib/neo4j.ts lib/neo4j.types.ts .env.local.example
git commit -m "feat: implement Neo4j connection manager"
```

## Phase: REFACTOR

### Refactoring Goals
- Add connection retry logic
- Improve error messages
- Add logging for debugging
- Create connection configuration helper

### Git Commit
```bash
git add lib/neo4j.ts
git commit -m "refactor: add retry logic and improve error handling"
```

## Pull Request

### Create PR
```bash
git push origin issue/002-neo4j-connection
gh pr create --title "Issue 002: Neo4j Connection Manager" \
             --body "$(cat issues/002.md)" \
             --label "backend"
```

### PR Checklist
- [ ] All 15+ tests pass
- [ ] Coverage >= 100%
- [ ] No TypeScript errors
- [ ] CI checks pass
- [ ] Code reviewed
- [ ] PR approved

### Merge
```bash
gh pr merge --squash
git checkout main
git pull origin main
```

## Acceptance Criteria
- [ ] Connection manager implements singleton pattern
- [ ] Health check works correctly
- [ ] Error handling covers all edge cases
- [ ] All tests pass (15+ tests)
- [ ] Coverage >= 100%
- [ ] CI checks pass ✅
- [ ] PR approved ✅
- [ ] Merged to main ✅

## Estimated Effort
**M** (Medium - Single module with comprehensive testing)

## Notes
- Ensure .env.local is in .gitignore
- Create .env.local.example for documentation
- Consider using connection pooling for performance
